---
- name: creating EC2 bastion server using Ansible
  hosts: localhost
  connection: local
  gather_facts: False
  tags: creating

  vars:
    keypair: RickyLopez
    instance_type: t2.micro
    image:  ami-04a50faf2a2ec1901
    wait: yes
    region: us-west-1
    subnet: subnet-0e5434ad06532d827
    group:
      - default
      - RL-BastHost-SG

  tasks:
    - name: Create EC2 Instance.
      block:
        - name: Launch bastion host.
          ec2:
            region: "{{ region }}" 
            key_name: "{{ keypair }}"
            group: "{{ group }}"
            instance_type: "{{ instance_type }}"
            image: "{{ image }}"
            wait: "{{ wait }}"
            wait_timeout: 500
            count: 1
            instance_tags:
              Name: RL-BastHost
            monitoring: yes
            vpc_subnet_id: "{{ subnet }}"
            assign_public_ip: yes
          register: ec2
          delegate_to: localhost

        - name: Add bastion to host group.
          add_host:
            hostname: "{{ ec2.instances[0].public_ip }}"
            groupname: launched
        
        - name: Set fact of EC2 public ip.
          set_fact:
            bast_ip: "{{ ec2.instances[0].public_ip }}"
            cacheable: yes
          
        - name: Wait for SSH port to be available.
          local_action:
            module: wait_for
            host: "{{ ec2.instances[0].public_ip }}"
            port: 22
            delay: 10
            timeout: 600
      tags: ['never', 'ec2-create']

- name: Configuring EC2 bastion server with necessary packages.
  hosts: launched
  remote_user: ec2-user
  gather_facts: true
  tags: provisioning

  tasks:
    - name: Configure EC2 Instance.
      block: 
        - name: Install yum-utils.
          yum:
            name: yum-utils
    
        - name: Add HashiCorp Linux repo.
          ansible.builtin.shell: yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo\
          become: true

        - name: Install Terraform.
          yum :
            name: terraform
          become: true

        - name: Install git.
          yum :
            name : git
          become: true

        - name: Pull devops repository.
          ansible.builtin.shell: git clone https://github.com/The-Black-Eyed-Beans/dev-ops-rl.git
          args:
            creates: "$HOME/dev-ops-rl/"

        - name: Switch to correct branch.
          ansible.builtin.shell: git checkout features/BA-124-Ansible-Playbooks
          args:
            chdir: dev-ops-rl/ 

        - name: Give execute permissions to kubectl.sh.
          ansible.builtin.file:
            path: dev-ops-rl/ansible/playbooks/kubectl.sh
            owner: root
            group: root
            mode: '777'
          become: true

        - name: Install kubectl.
          ansible.builtin.shell: .\kubectl.sh >> "$HOME/kubectl-log.txt"
          args:
            chdir: dev-ops-rl/ansible/playbooks/
          become: true 

      tags: ['never', 'ec2-configure']
  

  